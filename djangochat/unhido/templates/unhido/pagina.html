{% extends 'core/base.html' %}
{% load static %}

{% block title %}UNIHDO-Conicet | {% endblock %}

{%block css%}
    <link rel="apple-touch-icon" sizes="57x57" href="{% static 'fav.ico/apple-icon-57x57.png' %}">
    
    <link rel="apple-touch-icon" sizes="60x60" href="{% static 'fav.ico/apple-icon-60x60.png' %}">
    <link rel="apple-touch-icon" sizes="72x72" href="{% static 'fav.ico/apple-icon-72x72.png' %}">
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'fav.ico/apple-icon-76x76.png' %}">
    <link rel="apple-touch-icon" sizes="114x114" href="{% static 'fav.ico/apple-icon-114x114.png' %}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'fav.ico/apple-icon-120x120.png' %}">
    <link rel="apple-touch-icon" sizes="144x144" href="{% static 'fav.ico/apple-icon-144x144.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'fav.ico/apple-icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'fav.ico/apple-icon-180x180.png' %}">
    <link rel="icon" type="image/png" sizes="192x192"  href="{% static 'fav.ico/android-icon-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'fav.ico/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'fav.ico/favicon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'fav.ico/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'fav.ico/manifest.json' %}">
    <!--Open Sans Font -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=latin" rel="stylesheet">
    <!--MagicCheck Stylesheet -->
    <link href="/static/css/magic-check.min.css" rel="stylesheet">
    <!--Nifty Stylesheet -->
    <link href="/static/css/nifty.min.css" rel="stylesheet">
    <!--Nifty Stylesheet -->
    <link href="/static/css/conicet.css" rel="stylesheet">
    <link href="/static/css/base.css" rel="stylesheet">
    <!--Font Awesome -->
    <link href="/static/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" >
    <link href="/static/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css" rel="stylesheet">
    <link href="/static/plugins/datepicker/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="/static/plugins/select2/css/select2.min.css" rel="stylesheet">

{%endblock%}

{% block content %}
    <div id="container" class=" effect mainnav-lg">
        <!--NAVBAR--><!--===================================================-->
        <div id="navbar-container" class="boxed">
            <!--Brand logo & name--><!--================================-->
            <div class="navbar-header">
                <a href="/" class="navbar-brand">
                    <img src="/static/img/logo-conicet.png" alt="New Assets" class="brand-icon" style="padding: 10px;">
                    <div class="brand-title">
                        <span class="brand-text">UNIHDO</span>
                    </div>
                </a>
            </div>
        </div>
        <!--===================================================--><!--END NAVBAR-->
        
        <div class="boxed">
        <!--CONTENT CONTAINER--><!--===================================================-->
            <div id="content-container">
            <!--Page Title--><!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div id="page-title">
                    <h1 class="page-header text-overflow"><span class="fa fa-bookmark-o"></span>&nbsp;SA-Q20-O-None</h1>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--><!--End page title-->
                <!--Page content--><!--===================================================-->
                <div id="page-content">
                    <div class="col-sm-12">
                        <div class="panel">
                            <div class="panel-body">
                                <div class="tab-base">
                                    <form  method="POST" action="." class="form-horizontal" id="main-form" method="post"  enctype="multipart/form-data"> 
                                        {% csrf_token %}
                                            <ul class="nav nav-tabs"> 
                                                <li class="tab-pane active">
                                                    <a href="#general" data-toggle="tab">General</a>
                                                </li>
                                                <li class="tab-pane">
                                                    <a href="#items" data-toggle="tab">Items</a>
                                                </li>
                                            </ul>
                                            
                                            <div class="tab-content panel-body"> 
                                                <div id="general" class="tab-pane active" > 
                                                    <div id="div_id_date" class="form-group"> 
                                                        <label for="fecha_sol" class="control-label col-sm-4 requiredField">Fecha Requerida<span class="asteriskField">*</span></label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <div class="input-group input-group-sm date datepicker text-center" data-date="11/05/2023" data-date-format="dd/mm/yyyy" > 
                                                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span> 
                                                                <input type="text" class="form-control" id="fecha_sol" name="fecha_sol"/> 
                                                            </div> 
                                                        </div> 
                                                    </div> 
                                            
                                                    <div id="div_id_section" class="form-group"> 
                                                        <label for="unidad" class="control-label col-sm-4 requiredField">Sección<span class="asteriskField">*</span> </label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <select name="unidad" class="select form-control" required id="unidad"> 
                                                                <option name="unidad" value=""selected>UNIDADES</option> 
                                                                <option name="unidad" value="2" >Buque Oceanográfico ARA Puerto Deseado</option> 
                                                                <option name="unidad" value="3">Buque Oceanográfico ARA Austral</option> 
                                                                <option name="unidad" value="1">UNIHDO</option>
                                                            </select> 
                                                        </div> 
                                                    </div> 
                                            
                                                    <div id="div_id_sector" class="form-group"> 
                                                        <label for="depto" class="control-label col-sm-4">Departamento</label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <select name="depto" class="select form-control" id="depto"> 
                                                                <option value="" selected>Todos los Departamentos</option> 
                                                                <option value="A">Abastecimiento</option> 
                                                                <option value="C">Cubierta</option> 
                                                                <option value="M">Máquinas</option> 
                                                                <option value="O">Operaciones</option> 
                                                                <option value="S">Sanidad</option> 
                                                                <option value="SC">Segundo Comandante</option>
                                                            </select> 
                                                        </div> 
                                                    </div> 
                                            
                                                    <div id="div_id_category" class="form-group"> 
                                                        <label for="rubro" class="control-label col-sm-4 requiredField">Rubro<span class="asteriskField">*</span> </label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <select name="rubro" class="select form-control" id="rubro"> 
                                                                <option name="rubro" value="Bs.Consumo" selected>Bs.Consumo</option> 
                                                                <option name="rubro" value="Equipamiento">Equipamiento</option> 
                                                                <option name="rubro" value="Gs.Bancarios">Gs.Bancarios</option> 
                                                                <option name="rubro" value="Gs.Institucionales">Gs.Institucionales</option> 
                                                                <option name="rubro" value="Gs.Mant.Ed.">Gs.Mant.Ed.</option> 
                                                                <option name="rubro" value="Gs.Mant.Eq">Gs.Mant.Eq.</option> 
                                                                <option name="rubro" value="Otros Gastos">Otros Gastos</option> 
                                                                <option name="rubro" value="Pasajes y Viáticos">Pasajes y Viáticos</option> 
                                                                <option name="rubro" value="Seguros">Seguros</option> 
                                                                <option name="rubro" value="Serv.Basicos">Serv.Básicos</option> 
                                                                <option name="rubro" value="Serv.3 No Pe">Serv.3 No Pe.</option>
                                                            </select> 
                                                        </div> 
                                                    </div> 
                                            
                                                    <div id="div_id_reason" class="form-group"> 
                                                        <label for="objeto" class="control-label col-sm-4">Objeto de Contratación</label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <input type="text" name="objeto" maxlength="255" class="textinput textInput form-control" id="objeto"> 
                                                        </div> 
                                                    </div> 
                                                    
                                                    <div id="div_id_priority" class="form-group"> 
                                                        <label for="prioridad" class="control-label col-sm-4 requiredField">Prioridad<span class="asteriskField">*</span> </label> 
                                                        
                                                        <div class="controls col-sm-5"> 
                                                            <select name="prioridad" class="select form-control" id="prioridad"> 
                                                                <option name="prioridad" value="Normal" selected>Normal</option> 
                                                                <option name="prioridad" value="Alta">Alta</option></select> 
                                                        </div> 
                                                    </div> 

                                                    <div id="div_id_budget" class="form-group"> 
                                                        <label for="id_budget" class="control-label col-sm-4 requiredField">Especificaciones Técnicas<span class="asteriskField">*</span> </label> <div class="controls col-sm-5"> <input type="file" name="budget" class="clearablefileinput" required id="id_budget"> </div> </div> <div id="div_id_detail" class="form-group"> 
                                                            <label for="justifica" class="control-label col-sm-4 requiredField">Justificación<span class="asteriskField">*</span> </label> 
                                                            
                                                            <div class="controls col-sm-5"> 
                                                                <textarea name="justifica" cols="40" rows="10" class="textarea form-control" required id="justifica"></textarea> 
                                                            </div> 
                                                    </div> 

                                                    <div id="div_id_budget" class="hidden"> 
                                                        <input type="number" name="valida" id="valida" value="1"> 
                                                    </div> 
                                                </div>

                                                <div id="items" class="tab-pane" > 
                                                    <div id="item-table"> </div>
                                                </div>

                                            </div>
                                    
                                            <div  class="form-group form-action" class="form-group"> 
                                                <div class="aab controls col-sm-4"></div> 
                                                <div class="controls col-sm-5"> 
                                                    <input type="submit" name="save_changes" value="Guardar" class="btn btn-primary btn-success" id="submit-id-save_changes" />
                                                    <a class='text-danger' href='/purchases/provisioning'>Cancelar</a> 
                                                </div>
                                            </div> 

                                            
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <a class='text-warning' href="{% url 'crear' %}">CREAR</a>
                    <a class='text-warning' href="{% url 'pdf' %}">PDF</a>

                    <!--Item Modal--><!--===================================================-->
                    {% comment %} <div class="modal fade" id="item-modal" role="dialog" aria-labelledby="item-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">

                                <!--Modal header-->
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                                    <h4 class="modal-title">Item</h4>
                                </div>

                                <!--Modal body-->
                                <div class="modal-body">
                                    <form  class="form-horizontal" id="main-form" method="post" enctype="multipart/form-data" > 
                                        {% csrf_token %}
                                        <input type="hidden" name="csrfmiddlewaretoken" value="0SlTRDlE4AALu00ySuyrMTpWhE2pD5YNSA2r7EbsGzJXpTFOj96BwqeBE2Hber5y"> 
                                        <div id="div_id_name" class="form-group"> 
                                            <label for="id_name" class="control-label col-sm-4 requiredField">Nombre<span class="asteriskField">*</span> </label> 
                                            
                                            <div class="controls col-sm-5"> 
                                                <input type="text" name="name" maxlength="255" autocomplete="off" class="textinput textInput form-control" required id="id_name"> 
                                            </div> 
                                        </div> 
                                        
                                        <div id="div_id_unit" class="form-group"> 
                                            <label for="id_unit" class="control-label col-sm-4 requiredField">Unidad Medida<span class="asteriskField">*</span></label>
                                            <div class="controls col-sm-5"> 
                                                <select name="unit" class="select form-control" id="id_unit"> 
                                                    <option value="cm3">Centimetro 3</option> 
                                                    <option value="g">Gramo</option> 
                                                    <option value="kg">Kilogramo</option> 
                                                    <option value="l">Litro</option> 
                                                    <option value="mts">Metro</option> 
                                                    <option value="mts2">Metro 2</option> 
                                                    <option value="pq">Paquete</option> 
                                                    <option value="sg">Servicio General</option> 
                                                    <option value="u" selected>Unidad</option>
                                                </select> 
                                            </div> 
                                        </div> 
                                        
                                        <div id="div_id_quantity" class="form-group"> 
                                            <label for="id_quantity" class="control-label col-sm-4 requiredField">Cantidad<span class="asteriskField">*</span> </label> 
                                            <div class="controls col-sm-5"> 
                                                <input type="number" name="quantity" value="0.0" step="any" class="numberinput form-control" required id="id_quantity"> 
                                            </div> 
                                        </div> 
                                        
                                        <div id="div_id_obs" class="form-group"> 
                                            <label for="id_obs" class="control-label col-sm-4">Especificación</label> 
                                            <div class="controls col-sm-5"> 
                                                <textarea name="obs" cols="40" rows="3" class="textarea form-control" id="id_obs"></textarea> 
                                            </div> 
                                        </div> 
                                        
                                        <div  class="form-group form-action" class="form-group"> 
                                            <div class="aab controls col-sm-4"></div> 
                                            <div class="controls col-sm-5"> 
                                                <input type="submit" name="save_changes" value="Guardar" class="btn btn-primary btn-success" id="submit-id-save_changes"/>
                                                <a class='btn btn-primary btn-continue'>Guardar y Continuar</a>
                                                <a class='text-danger' data-dismiss='modal' href='/'>Cancelar</a> 
                                            </div>
                                        </div> 
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div> {% endcomment %}
                    <!--===================================================--><!--End Item Modal-->

                    <template id="item-template">

                    <div class="row pad-btm">
                        <div class="col-sm-12 text-right">
                            <button type="button" class="btn btn-primary" data-target="#item-modal" data-toggle="modal"><span class="fa fa-plus"></span> Nuevo</button>
                        </div>
                    </div>

                    <table class="table table-striped table-bordered big"
                        cellspacing="0"
                        width="100%">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>U. Medida</th>
                                <th>Cantidad</th>
                                <th width="50px">&nbsp;</th>
                                <th width="100px">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="no-data-found" style="display: none"><td colspan="5">No hay datos disponibles</td></tr>
                        </tbody>
                    </table>
                    </template>
                </div>
                <!--===================================================--><!--End page content-->
            </div>
    <!--===================================================--><!--END CONTENT CONTAINER-->
        </div>
    </div>
{%endblock%}

{% block scripts %}
    <script src="{% static 'js/nifty.min.js' %}"></script>
    <script src="{% static 'plugins/select2/js/select2.min.js' %}"></script>
    <script src="{% static 'plugins/select2/js/i18n/es.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $("select").select2({width: '100%'});

            $('.input-group.date').datepicker({
                format: "dd/mm/yyyy",
                autoclose:true,
                enableOnReadonly: false
            });

        });
    </script>

    <script src="{% static 'js/typeahead.js' %}"></script>
    <script src="{% static 'js/sv.dataTables.js' %}"></script>

    <script>
        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        function check_empty_data() {
            if ($('#item-table tbody tr').length == 1) {
                $('#item-table tbody tr.no-data-found').show()
            }
            else {
                $('#item-table tbody tr.no-data-found').hide()
            }
        }

        $(document).ready(function() {
            var UNIHDO='1',
                $product = $('#id_name') ;
                save_and_continue=false;

            $("select").select2({
                minimumResultsForSearch: -1,
                width: '100%'
            });

            $.get("/stock/autocomplete", function(data){
            $product.typeahead({
                source: data,
                fitToElement: true,
            });
            },'json');

            $product.change(function() {
            current = $product.typeahead("getActive");
            if (current && current.name === $('#id_name').val()) {
                $('#id_unit').val(current.unit).trigger('change');
            }
            });

            $('#id_section').on('select2:select', function (e) {

                if ($(this).val() === UNIHDO) {
                    $('#id_sector').val('')
                    $('#div_id_sector').hide('slow')
                }
                else {
                    $('#div_id_sector').show('slow')
                }
            });

            $('#id_category').on('select2:select', function (e) {
                if ($(this).val() > 1) {
                    $('#div_id_obs label').text("Observación")
                } else {
                    $('#div_id_obs label').text("Especificación")
                }
            });


            if ($('#id_section').val() === UNIHDO ) {
                    $('#div_id_sector').hide()
            }

            var _template = document.querySelector('#item-template');
            $('#item-table').append(document.importNode(_template.content, true));

            $('#item-modal').on('hidden.bs.modal', function () {
                $('#item-modal form')[0].reset();
                if (save_and_continue === true) {
                    $('#item-modal').modal('show');
                }
                save_and_continue=false;
            });

            $('#item-modal').on('shown.bs.modal', function () {
                $('#id_unit').val('u').trigger('change');
                $('#id_quantity').val('1.00');
                $('#id_name').focus();
            });

            $('#item-modal .btn-continue').on('click', function () {
                save_and_continue=true;
                $('#item-modal .btn-success').trigger('click');
            });

            $('#item-modal form').submit(function () {
                var data = $(this).serializeObject(),
                    technical = '&mdash;',
                    btn_edit = '<a class="btn btn-icon btn-warning" data-target="#item-modal" data-toggle="modal"><span class="fa fa-pencil"></span></a>',
                    btn_delete = '<a class="btn btn-icon btn-danger"><span class="fa fa-trash"></span></a>',
                    markup = "<tr><td>$1</td><td data-pk='$2'>$3</td><td>$4</td><td class='text-center'>$5</td><td class='text-center'>$6</td></tr>";

                if (data.obs && data.obs.length > 0) {
                    technical = '<span class="fa fa-info-circle" data-toggle="tooltip" data-placement="top" data-title="$OBS"></span>';
                    technical = technical.replace('$OBS', data.obs);
                }
                markup = markup.replace('$1', data.name);
                markup = markup.replace('$2', data.unit);
                markup = markup.replace('$3', $('#id_unit').select2('data')[0].text);
                markup = markup.replace('$4', Number(data.quantity).toFixed(2));
                markup = markup.replace('$5', technical);
                markup = markup.replace('$6', btn_delete);

                $('#item-table tbody').append(markup);

                $('#item-modal').modal('hide');
                $('[data-toggle="tooltip"]').tooltip()

                check_empty_data();

                return false
            });

            $(document).on('click', 'table .btn-danger', function (ev) {
                ev.preventDefault();

                var $tr = $(this).closest('tr'),
                    delete_url = $tr.data('url');
                $tr.remove();

                if (delete_url) {
                    SouthVisionApp.DataTable.delete(delete_url);
                }

                check_empty_data();
            });

            $(document).on('click', 'table .btn-warning', function (ev) {

                var $tr = $(this).closest('tr');

                $('#id_name').val($('td:eq(0)', $tr).text());
                $('#id_unit').select2('val', $('td:eq(1)', $tr).data('pk'));
                $('#id_quantity').val($('td:eq(2)', $tr).text());
            });

            $('#main-form').submit(function () {
                $('#item-table tbody tr.no-data-found').remove();
                $('#item-table tbody tr').each(function (idx, val) {
                    var $tr = $(this),
                        pk = $tr.data('pk'),
                        $info = $('td:eq(3) .fa-info-circle', $tr),
                        values = [
                            pk ? pk : 0,
                            $('td:eq(0)', $tr).text(),
                            $('td:eq(1)', $tr).data('pk'),
                            $('td:eq(2)', $tr).text(),
                            $info.length > 0 ? $info.data('title') : '',
                    ];

                    $('<input>').attr({
                    type: 'hidden',
                    name: 'item_' + idx,
                    }).val(values.join('||')).appendTo($('#main-form'));
                });

                return true;
            });

            check_empty_data();

            $('#item-modal .form-action .controls.col-sm-5').removeClass('col-sm-5').addClass('col-sm-8')
        });
    </script>

    <script>
        var UNIDHO=1, ALL_SECTORS='';

        $(document).ready(function() {

        //Activate the Bootstrap Tooltips & Popovers
        $('[data-toggle="tooltip"]').tooltip()

        
        })
    </script>
{%endblock%}